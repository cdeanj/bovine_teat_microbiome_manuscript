# Code adapted from A DADA2 workflow for Big Data: Paired-end (1.4 or later)
# https://benjjneb.github.io/dada2/bigdata_paired.html

library(dada2); packageVersion("dada2")
# Merge multiple runs
st1 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_008_OREI_1/rds/seqtab.rds")
st2 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_009_OREI_2/rds/seqtab.rds")
st3 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_010_OREI_3/rds/seqtab.rds")
st4 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_012_OREI_4/rds/seqtab.rds")
st5 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_013_OREI_5/rds/seqtab.rds")
st6 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_015_OREI_6/rds/seqtab.rds")
st7 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_016_OREI_7/rds/seqtab.rds")
st8 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_018_OREI_8/rds/seqtab.rds")
st9 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_020_OREI_9/rds/seqtab.rds")
st10 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_022_OREI_10/rds/seqtab.rds")
st11 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_023_OREI_11/rds/seqtab.rds")
st12 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_024_OREI_12/rds/seqtab.rds")
st13 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_025_OREI_13/rds/seqtab.rds")
st14 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_034_OREI_14/rds/seqtab.rds")
st15 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_037_OREI_15/rds/seqtab.rds")
st16 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_038_OREI_16/rds/seqtab.rds")
st17 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_040_OREI_17/rds/seqtab.rds")
st18 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_042_OREI_18/rds/seqtab.rds")
st19 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_045_OREI_19/rds/seqtab.rds")
st20 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_046_OREI_20/rds/seqtab.rds")
st21 <- readRDS("/home/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/03.Inference/Batch_Noyes_Project_048_OREI_21/rds/seqtab.rds")


row.names(st1) <- paste0("Batch_1_", row.names(st1))
row.names(st2) <- paste0("Batch_2_", row.names(st2))
row.names(st3) <- paste0("Batch_3_", row.names(st3))
row.names(st4) <- paste0("Batch_4_", row.names(st4))
row.names(st5) <- paste0("Batch_5_", row.names(st5))
row.names(st6) <- paste0("Batch_6_", row.names(st6))
row.names(st7) <- paste0("Batch_7_", row.names(st7))
row.names(st8) <- paste0("Batch_8_", row.names(st8))
row.names(st9) <- paste0("Batch_9_", row.names(st9))
row.names(st10) <- paste0("Batch_10_", row.names(st10))
row.names(st11) <- paste0("Batch_11_", row.names(st11))
row.names(st12) <- paste0("Batch_12_", row.names(st12))
row.names(st13) <- paste0("Batch_13_", row.names(st13))
row.names(st14) <- paste0("Batch_14_", row.names(st14))
row.names(st15) <- paste0("Batch_15_", row.names(st15))
row.names(st16) <- paste0("Batch_16_", row.names(st16))
row.names(st17) <- paste0("Batch_17_", row.names(st17))
row.names(st18) <- paste0("Batch_18_", row.names(st18))
row.names(st19) <- paste0("Batch_19_", row.names(st19))
row.names(st20) <- paste0("Batch_20_", row.names(st20))
row.names(st21) <- paste0("Batch_21_", row.names(st21))

# Merge sequence tables
st.all <- mergeSequenceTables(st1, st2, st3, st4, st5, st6, st7, st8, st9, st10, st11, st12, st13, st14, st15, st16, st17, st18, st19, st20, st21)
# Remove chimeras
seqtab <- removeBimeraDenovo(st.all, method="consensus", multithread=TRUE)
# Assign taxonomy
tax <- assignTaxonomy(seqtab, "/panfs/roc/groups/11/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/reference/silva_nr99_v138.1_train_set.fa", multithread = TRUE)
tax <- addSpecies(tax, "/panfs/roc/groups/11/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/reference/silva_species_assignment_v138.1.fa", allowMultiple = TRUE)
# Write to disk
saveRDS(seqtab, "/panfs/roc/groups/11/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/04.Taxonomy/seqtab_merged_03042022.rds")
saveRDS(tax, "/panfs/roc/groups/11/noyes046/dean0358/Projects/01.OREI_Gauze_Microbiome/results/04.Taxonomy/tax_merged_03042022.rds")
